var FacebookStrategy,User,request;request=require("request"),FacebookStrategy=require("passport-facebook").Strategy,User=require("./../models/user.js"),module.exports.configure=function(a){var b,c;return b=a.locals.config,c=a.locals.passport,c.use(new FacebookStrategy({clientID:b.facebook.appId,clientSecret:b.facebook.appSecret,callbackURL:""+b.oAuthCallbackBaseUrl+"/auth/facebook/callback",profileFields:["id","name","displayName","profileUrl","photos","gender","location","friends"],scope:["user_location","friends_photos"]},function(a,b,c,d){return User.findOne({facebookId:c.id},function(b,e){return console.log("facebook profile data: ",c),e||(e=new User({facebookId:c.id})),e.name=c.displayName,c.photos&&c.photos[0]&&(e.imageUrl=c.photos[0].value),c.gender&&(e.gender=c.gender),c._json.location&&(e.location=c._json.location.name),e.profileUrl=c.profileUrl,e.authenticationToken=a,e.save(function(b,c){return request("https://graph.facebook.com/me/friends?access_token="+a+"&fields=name,id,picture",function(a,e,f){var g,h,i,j,k;if(console.log("facebook friend data: ",f),a||200!==e.statusCode)return d(b,c.getBasicProfileObject());for(h=[],k=JSON.parse(f).data,i=0,j=k.length;j>i;i++)g=k[i],h.push({id:g.id,name:g.name,imageUrl:g.picture.data.url});return c.facebookFriends=h,c.save(function(a){return d(a,c.getBasicProfileObject())})})})})}))};