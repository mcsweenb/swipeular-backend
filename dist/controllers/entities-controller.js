var Entity,auth;auth=require("./../lib/auth"),Entity=require("./../models/entity"),module.exports=function(a){var b,c;return b={opinions:{}},c=a.locals.mongoose,b.index=function(a,b){var c;return c=Entity.find(),a.query.includeOpinions||c.select("-opinions"),a.query.limit&&c.limit(a.query.limit),c.exec(function(a,c){return a?b.status(500).send(a):b.status(200).send(c)})},b.findByCategory=function(a,b){var c;return c=Entity.find(),a.query.includeOpinions||c.select("-opinions"),a.query.limit&&c.limit(a.query.limit),c.exec(function(a,c){return a?b.status(500).send(a):b.status(200).send(c)})},b.create=function(a,b){var c;return c=new Entity(a.body),c.save(function(a){return a?b.status(422).send(a):b.status(201).send(c)})},b.opinions.create=function(a,b){return auth.authenticateRequest(a,b,function(c){var d,e,f,g;return d=a.params.id,e="true"===a.body.like||a.body.like===!0,d?(f={_id:d,"opinions.userId":c._id},g={$set:{"opinions.$.like":e}},Entity.update(f,g).exec(function(a,h){return a?b.status(422).send(a):h>0?(Entity.updateLikeCountsForEntityWithId(d),b.status(204).send()):(f={_id:d},g={$push:{opinions:{userId:c._id,like:e}}},Entity.update(f,g).exec(function(a){return a?b.status(422).send(a):(Entity.updateLikeCountsForEntityWithId(d),b.status(201).send())}))})):b.status(422).send({errors:{entityId:"is required"}})})},b};