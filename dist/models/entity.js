var Entity,entitySchema,mongoose,_;_=require("underscore"),mongoose=require("mongoose"),entitySchema=new mongoose.Schema({category:{type:String},name:{type:String,required:!0,trim:!0},relativeImagePath:{type:String,required:!0,trim:!0},relativeRelatedImagePath:{type:String,trim:!0},source:{type:String},url:{type:String,trim:!0},price:{type:Number},description:{type:String,trim:!0},likeCount:{type:Number,"default":0},dislikeCount:{type:Number,"default":0},opinions:{type:Array,"default":[]},isProduct:{type:Boolean}}),Entity=mongoose.model("Entity",entitySchema),Entity.updateLikeCountsForEntityWithId=function(a,b){return"ObjectID"!==a._bsontype&&(a=new mongoose.Types.ObjectId(a)),Entity.aggregate([{$match:{_id:a}},{$unwind:"$opinions"},{$group:{_id:"$opinions.like",count:{$sum:1}}},{$project:{_id:0,like:"$_id",count:"$count"}}]).exec(function(c,d){var e,f;return f=0,e=0,_.each(d,function(a){return("true"===a.like||a.like===!0)&&(f+=a.count),"false"===a.like||a.like===!1?e+=a.count:void 0}),Entity.update({_id:a},{$set:{likeCount:f,dislikeCount:e}}).exec(function(a,c){return b?b(a,c):void 0})})},module.exports=Entity;